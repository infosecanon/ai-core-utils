name: Python CI

# 1. Triggers: Equivalent to ADO 'trigger' and 'pr'
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# 2. Permissions: Needed to write test results to PR comments (optional but recommended)
permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-22.04 # Matches your 'pool' image

    steps:
    # 3. Checkout: GHA requires this explicitly (ADO did it automatically)
    - uses: actions/checkout@v4

    # 4. Setup Python
    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        cache: 'pip' # BONUS: GHA has built-in caching for pip!

    # 5. Install Dependencies
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install pyarrow --only-binary :all:
        python -m pip install -r requirements.txt
        # Dev dependencies
        python -m pip install pytest ruff mypy pandas types-requests types-PyYAML

    # 6. Run Ruff
    # continue-on-error: true lets the pipeline proceed to Mypy even if Ruff fails
    - name: Run Ruff Linting
      run: python -m ruff check . --output-format=github
      continue-on-error: true

    # 7. Run Mypy
    - name: Run Mypy Type Checking
      # We use the same flags as before
      run: python -m mypy . --ignore-missing-imports
      continue-on-error: true

    # 8. Run Pytest
    # We generate JUnit XML to visualize results in the PR
    - name: Run Pytest
      env:
        PYTHONPATH: src
      run: python -m pytest --junitxml=test-results.xml

    # 9. Publish Test Results (The GHA equivalent of the 'Tests' tab)
    # This Action reads the XML and posts a formatted table to the PR
    - name: Publish Test Results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: test-results.xml
